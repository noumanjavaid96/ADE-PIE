# Pipedream Implementation Guide (v2.0)

## 1. Overview

This document provides the technical specification for the backend service that calculates a user's Confidence Score and generates dynamic coaching responses. The entire logic is encapsulated within an updated Pipedream workflow.

This service is designed to be called by the `learning_simulator` application whenever a user completes a scorable event. It processes the event, updates the user's score, logs the result, and generates a personalized coaching message from "Coach Klaus."

---

## 2. API Endpoint & Method

The frontend will interact with this service by sending a `POST` request to the Pipedream workflow's unique webhook URL.

-   **Method:** `POST`
-   **Endpoint URL:** `https://endpoint.m.pipedream.net` (This is a placeholder. The final URL will be generated by Pipedream upon workflow deployment.)

### Authentication

Requests must include an `Authorization` header containing the Pipedream API key.

-   **Header:** `Authorization`
-   **Value:** `Bearer 77f8cd5d925a2e69b392021ecad31d16`

---

## 3. API Contract

### 3.1. Request Body (Frontend -> Pipedream)

The frontend must send a JSON object in the request body with the following structure:

```json
{
  "userId": "user_sim_001",
  "eventType": "QUIZ_ANSWERED",
  "eventOutcome": "CORRECT",
  "previousConfidenceScore": 50
}
```

-   `userId` (string, required): The unique identifier for the user.
-   `eventType` (string, required): A string describing the type of event.
-   `eventOutcome` (string | number | boolean, required): The result of the event.
-   `previousConfidenceScore` (number, required): The user's confidence score *before* the current event. This is crucial for making the simulation stateful.

### 3.2. Response Body (Pipedream -> Frontend)

The workflow is configured to return a custom JSON response containing the output of the final step. The `learning_simulator` UI expects the following structure:

```json
{
  "confidenceScore": 64,
  "coachingResponse": "That's it! Correctly identifying the benefits of scalability shows you have a strong grasp of this concept. Well done!"
}
```

-   `confidenceScore` (number, required): The new, updated confidence score.
-   `coachingResponse` (string, required): The personalized message from Coach Klaus.

---

## 4. Workflow Breakdown (v2.0)

The Pipedream workflow consists of three main steps that execute in sequence.

### Step 1: `calculate_confidence_score`

This is a custom Pipedream component responsible for all the scoring logic.

-   **Purpose:** To calculate the user's new Confidence Score based on their most recent action.
-   **Inputs (Props):**
    -   `user_id`, `event_type`, `event_outcome`: Pulled from the trigger event body.
    -   `previous_confidence_score`: **Crucially, this should be mapped from the trigger body.** (See Section 5).
-   **Core Functionality:**
    1.  Assigns a raw score (`eventImpact`) to the incoming event.
    2.  Calculates the new `confidenceScore` using a smoothing formula.
    3.  Determines the user's `coachingZone` (e.g., Z1-Z6) based on the new score.
-   **Output (`$return_value`):** A JSON object containing the full results of the calculation.

### Step 2: `neon_postgres`

This step provides data persistence.

-   **Purpose:** To log the results of the confidence score calculation to the database.
-   **Functionality:** It connects to the project's Neon Postgres database and saves the output from the previous step.

### Step 3: `generate_coaching_response`

This step leverages OpenAI's GPT-4.1 model to generate a dynamic, personalized coaching message.

-   **Purpose:** To create an empathetic and context-aware response for the user.
-   **Functionality:**
    1.  It constructs a detailed prompt for the LLM using the data from the first step (`confidenceScore`, `coachingZone`, etc.).
    2.  The `systemInstructions` field contains the master prompt that defines the "Coach Klaus" persona.
-   **Output:** The final coaching message to be sent to the user.

---

## 5. Crucial Improvement: Making the Demo Stateful

For the `learning_simulator` to work correctly and show a score that changes over time, the Pipedream workflow needs one critical modification.

The `previous_confidence_score` prop in the `calculate_confidence_score` step is currently hardcoded to `50`. It needs to read the value sent from our simulator instead.

**How to Fix:**

1.  In the Pipedream workflow editor, go to the `calculate_confidence_score` step.
2.  Find the `previous_confidence_score` prop.
3.  Click the prop to open the path selector.
4.  Change the value from the static number `50` to the following path from the trigger:
    `{{ steps.trigger.event.body.previousConfidenceScore }}`

This will ensure the workflow uses the score sent from the simulator, making the entire feedback loop dynamic and stateful.

---

## 6. Validation UI

A simple validation UI is available to test the Pipedream workflow.

-   **Location:** `/learning_simulator/index.html`
-   **Purpose:** To send test events to the workflow and visualize the generated coaching response and updated score.
-   **How to Use:** Open the file in a browser and paste your Pipedream webhook URL into the input field at the bottom of the sidebar.