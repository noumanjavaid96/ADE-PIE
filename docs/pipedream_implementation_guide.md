# Pipedream Implementation Guide: Confidence Score & Coaching AI

## 1. Overview

This document provides the technical specification for the backend service that calculates a user's Confidence Score and generates dynamic coaching responses. The entire logic is encapsulated within a Pipedream workflow.

This service is designed to be called by the frontend application whenever a user completes a scorable event. It processes the event, updates the user's score, logs the result, and generates a personalized coaching message from "Coach Klaus."

---

## 2. API Endpoint & Method

The frontend will interact with this service by sending a `POST` request to the Pipedream workflow's unique webhook URL.

-   **Method:** `POST`
-   **Endpoint URL:** `https://endpoint.m.pipedream.net` (This is a placeholder. The final URL will be generated by Pipedream upon workflow deployment.)

### Authentication

Requests must include an `Authorization` header containing the Pipedream API key.

-   **Header:** `Authorization`
-   **Value:** `Bearer 77f8cd5d925a2e69b392021ecad31d16`

---

## 3. API Contract

### 3.1. Request Body (Frontend -> Pipedream)

The frontend must send a JSON object in the request body with the following structure:

```json
{
  "userId": "user_12345",
  "eventType": "QUIZ_ANSWERED",
  "eventOutcome": "CORRECT"
}
```

-   `userId` (string, required): The unique identifier for the user.
-   `eventType` (string, required): A string describing the type of event that occurred (e.g., `QUIZ_ANSWERED`, `HELP_REQUESTED`, `VIDEO_COMPLETED`).
-   `eventOutcome` (string | number | boolean, required): The result of the event (e.g., `CORRECT`, `INCORRECT`, `85` for a percentage, `true`).

### 3.2. Response (Pipedream -> Frontend)

-   **Immediate Response:** The Pipedream trigger is configured to provide an immediate, static response to acknowledge receipt of the event. This prevents the client from timing out while the full workflow executes.
    -   **Status Code:** `200 OK`
    -   **Body:** `"OK"`

-   **Asynchronous Coaching Response:** The actual coaching message is generated asynchronously. The frontend will need to receive this message via a push mechanism.
    -   **Proposed Architecture:** The final step of the Pipedream workflow should be modified to push the generated coaching response to a real-time service (e.g., a WebSocket server like Pusher or Ably) that the frontend is subscribed to. The frontend will listen for an event on a user-specific channel (e.g., `coaching-response-user_12345`) to receive the message.

---

## 4. Workflow Breakdown

The Pipedream workflow consists of three main steps that execute in sequence after being triggered by an HTTP request.

### Step 1: `calculate_confidence_score`

This is a custom Pipedream component responsible for all the scoring logic.

-   **Purpose:** To calculate the user's new Confidence Score based on their most recent action.
-   **Inputs (Props):**
    -   `user_id`: Pulled from the trigger event body.
    -   `event_type`: Pulled from the trigger event body.
    -   `event_outcome`: Pulled from the trigger event body.
    -   `previous_confidence_score`: The user's score before this event. **Note:** This needs to be fetched from the database, not hardcoded.
    -   `smoothing_previous_weight` / `smoothing_new_weight`: The weights for the smoothing formula.
-   **Core Functionality:**
    1.  Assigns a raw score (`eventImpact`) to the incoming event.
    2.  Calculates the new `confidenceScore` using the smoothing formula.
    3.  Determines the user's `coachingZone` (e.g., Z1-Z6) based on the new score.
-   **Output (`$return_value`):** A JSON object containing the full results of the calculation (e.g., `userId`, `confidenceScore`, `coachingZone`, `eventImpact`, `previousScore`).

### Step 2: `neon_postgres`

This step provides data persistence.

-   **Purpose:** To log the results of the confidence score calculation to the database.
-   **Functionality:** It connects to the project's Neon Postgres database and saves the output from the `calculate_confidence_score` step. This is critical for tracking user progress and retrieving the `previous_confidence_score` for the next event.

### Step 3: `generate_coaching_response`

This step leverages OpenAI's GPT-4.1 model to generate a dynamic, personalized coaching message.

-   **Purpose:** To create an empathetic and context-aware response for the user.
-   **Functionality:**
    1.  It constructs a detailed prompt for the LLM using the data from the first step (`confidenceScore`, `coachingZone`, `eventType`, `eventOutcome`).
    2.  The `systemInstructions` field contains the master prompt that defines the "Coach Klaus" persona and its adaptive behavior based on the user's coaching zone.
    3.  It sends the request to the OpenAI API and receives a generated text message.
-   **Output:** The final coaching message to be sent to the user. As noted in section 3.2, this output needs to be pushed to the client via a real-time service.

---

## 5. Validation UI

A simple validation UI has been created to allow for easy testing of the Pipedream workflow.

-   **Location:** `/ui/index.html`
-   **Purpose:** To send test events to the workflow and visualize the generated coaching response from Coach Klaus.

### How to Use

1.  Open the `ui/index.html` file in a web browser.
2.  Enter your unique Pipedream webhook URL into the "Pipedream Endpoint URL" field.
3.  Fill in the `userId`, `eventType`, and `eventOutcome` fields with test data.
4.  Click the "Trigger Workflow" button.
5.  The response from Coach Klaus will appear in the results section.

### Important Note for Testing

For the validation UI to work correctly, the Pipedream workflow must be temporarily configured to return the final coaching response directly.

**By default, the workflow trigger is set to return an immediate `200 OK` static response.** To test with this UI, you must change the trigger's "Response Type" setting from `staticResponse` to return the output of the final step (`steps.generate_coaching_response.$return_value`). This will cause the workflow to wait until the final step is complete before sending the HTTP response, allowing the UI to capture and display the result.

**Remember to revert this change** for production use, where an asynchronous push mechanism (e.g., WebSockets) will be used to deliver the response to the client.